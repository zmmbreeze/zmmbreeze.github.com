GAæºä»£ç é‡Œçš„å°æŠ€å·§ä¹‹cookieç¯‡
===

> ä½œè€…å‰æ®µæ—¶é—´åœ¨åšç±»ä¼¼Google Analyticsï¼ˆä»¥ä¸‹ç®€ç§°GAï¼‰çš„ç¬¬ä¸‰æ–¹ç›‘æ§è„šæœ¬ã€‚æ‰€ä»¥å¯¹GAçš„å‰ç«¯ä»£ç åšè¿‡è°ƒç ”ï¼Œå¯¹GAçš„å‹ç¼©åä»£ç åšäº†ä¸€å®šç¨‹åº¦ä¸Šçš„[äººè‚‰ç¾åŒ–](https://gist.github.com/zmmbreeze/ddb4b3a619187b923dc2c009b4323a42)ã€‚è¿™é‡Œç¾åŒ–çš„æ˜¯[analytics.js](https://www.google-analytics.com/analytics.js)çš„j41ç‰ˆæœ¬ï¼Œæœ¬æ–‡æåˆ°çš„å°æŠ€å·§ä¹Ÿæ˜¯åŸºäºè¿™ä¸ªç‰ˆæœ¬çš„jsã€‚

cookieçš„æœ¬è´¨æ˜¯å­˜å‚¨åœ¨æµè§ˆå™¨ç«¯çš„ä¸€æ®µç®€å•æ•°æ®ï¼ˆå¤šä¸ªé”®å€¼å¯¹ï¼‰ï¼Œæµè§ˆå™¨ä¼šä»æœåŠ¡å™¨æ¥å—æˆ–è€…å‘é€ç»™æœåŠ¡å™¨cookieã€‚è¿™æ ·ä¾¿å¯ä»¥ä¸ºæ²¡æœ‰çŠ¶æ€çš„HTTPåè®®æä¾›äº†è®°å½•çŠ¶æ€ä¿¡æ¯çš„æ–¹æ³•ï¼ŒçŸ¥é“å¤šä¸ªä¸åŒçš„HTTPè¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€ä¸ªæµè§ˆå™¨ã€‚

åœ¨æµè§ˆå™¨ä¸­cookieæ˜¯æ”¯æŒèŒƒå›´æœ€å¹¿çš„å­˜å‚¨æ•°æ®çš„æ‰‹æ®µäº†ï¼Œå‰ç«¯å·¥ç¨‹å¸ˆä¸€èˆ¬éƒ½æ›¾ç»æˆ–å¤šæˆ–å°‘çš„ä½¿ç”¨è¿‡cookieæ¥å­˜å‚¨æ•°æ®æˆ–å˜é‡ã€‚æµè§ˆå™¨æä¾›äº†`document.cookie`è¿™ä¸ªæ¥å£æ¥å¢åˆ æ”¹æŸ¥cookieã€‚ä½†æ˜¯åªèƒ½ä¸€æ¬¡è®¾ç½®ä¸€ä¸ªcookieã€‚ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š

```javascript
// è®¾ç½®åä¸ºkeyçš„cookieï¼Œå€¼ä¸ºvalue
document.cookie = 'key=value';
```

ä»£ç ä¸­çœç•¥äº†å…¶ä»–å¯é€‰é…ç½®ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒ[MDNæ–‡æ¡£](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/cookie)ã€‚é€šè¿‡`domain`å’Œ`path`å‚æ•°ï¼Œå¯ä»¥å°†cookieè®¾ç½®åœ¨ä¸åŒçš„åŸŸåæˆ–è€…è·¯å¾„ä¸‹ï¼Œä¾‹å¦‚ï¼š

```javascript
// è®¾ç½®åä¸ºkeyçš„cookieï¼Œå€¼ä¸ºvalue
document.cookie = 'A=1;path=/;domain=map.baidu.com;';
```

ä¸Šé¢çš„ä»£ç åœ¨åŸŸå`map.baidu.com`ä¸‹çš„æ ¹è·¯å¾„ï¼ˆ`/`ï¼‰è®¾ç½®äº†cookie Açš„å€¼ä¸º`1`ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡`document.cookie`æ¥è·å–å½“å‰åŸŸåå’Œè·¯å¾„ä¸‹çš„æ‰€æœ‰cookieã€‚å½“æˆ‘ä»¬è®¿é—®`http://map.baidu.com`é¡µé¢æ—¶ï¼Œæ‰§è¡Œ`document.cookie`è·å¾—çš„ç»“æœæ˜¯`A=1`ã€‚

å¤§å®¶çŸ¥é“åŸŸåæ˜¯æœ‰çˆ¶åŸŸåå’Œå­åŸŸåçš„åŒºåˆ«çš„ï¼Œé”®åç›¸åŒçš„ä¸¤ä¸ªcookieå¯ä»¥åˆ†åˆ«è®¾ç½®åœ¨çˆ¶å­åŸŸåä¸Šã€‚ä¾‹å¦‚å¦‚ä¸‹ä»£ç ï¼š

```javascript
document.cookie = 'A=1;path=/;domain=.example.com;';
document.cookie = 'A=2;path=/;domain=a.example.com;';
```

> é¡ºå¸¦æåˆ°ä¸€ä¸ªå†·é—¨çš„çŸ¥è¯†ç‚¹ï¼šä»¥`.`å¼€å¤´çš„åŸŸåè¡¨ç¤ºcookieè®¾ç½®åœ¨æ­¤åŸŸååŠå…¶å­åŸŸä¸Šï¼Œå¦åˆ™ä¸é€‚ç”¨äºå…¶å­åŸŸåã€‚ä¸è¿‡ä»[RFC 2965](http://www.ietf.org/rfc/rfc2965.txt)æ ‡å‡†å¼€å§‹æµè§ˆå™¨ä¾¿ä¼šè‡ªåŠ¨ä¸ºdomainå±æ€§å€¼è‡ªåŠ¨æ·»åŠ ä¸€ä¸ª`.`å‰ç¼€ï¼Œæ‰€ä»¥åœ¨è®¾ç½®`domain`æ—¶åŠ ä¸åŠ `.`å‰ç¼€å·²ç»æ²¡æœ‰åŒºåˆ«äº†ã€‚ä½†æ˜¯ä¸ºäº†å…¼å®¹ä¸€äº›æ—§æµè§ˆè¿˜æ˜¯åŠ `.`ä¸ºå¥½ã€‚å¦å¤–å¦‚æœä¸è®¾ç½®`domain`æµè§ˆå™¨ä¼šé»˜è®¤ç”¨å½“å‰é¡µé¢çš„åŸŸåï¼Œè¿™æ—¶æµè§ˆå™¨ä¸ä¼šè‡ªåŠ¨æ·»åŠ `.`å‰ç¼€ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸ä¼šåŒ…å«å­åŸŸäº†ã€‚

åœ¨`.example.com`å’Œ`a.example.com`åŸŸåä¸‹é¢åˆ†åˆ«è®¾ç½®äº†`A=1`å’Œ`A=2`ä¸¤ä¸ªcookieã€‚æ­¤æ—¶æˆ‘ä»¬åœ¨`http://a.example.com`é¡µé¢ä¸‹æ‰§è¡Œ`document.cookie`å¾—åˆ°çš„ç»“æœæ˜¯ï¼š`A=1;A=2`ã€‚å¦‚ä¸‹å›¾ï¼š

![2](https://cloud.githubusercontent.com/assets/249872/18791619/0fe6206c-81e6-11e6-99c3-ab043142e750.png)

å¼€å‘è€…æ˜¯æ²¡åŠæ³•ä»ç»“æœä¸­çŸ¥é“è¿™ä¸ªcookieæ˜¯è®¾ç½®åœ¨å“ªä¸ªåŸŸåä¸Šçš„ã€‚åŒæ ·è¿™ä¸ªæƒ…å†µä¹Ÿé€‚ç”¨äºä¸åŒçš„çˆ¶å­è·¯å¾„ä¸Šã€‚

è¿™åœ¨ä¸€èˆ¬æƒ…å†µä¸‹å¯¹å¼€å‘è€…ä¸ä¼šæœ‰å½±å“ï¼Œä½†æ˜¯å¯¹äºGAæ¥è¯´ç¡®å®è‡´å‘½çš„ã€‚GAä¼šåœ¨å½“å‰ç½‘ç«™åŸŸåä¸‹é¢è®¾ç½®ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„cookie `_ga`ï¼Œç”¨äºæ ‡å¿—ç›¸åŒçš„ç”¨æˆ·ã€‚ç°åœ¨å¤§å‹çš„å…¬å¸éƒ½ä¼šåˆ†ä¸åŒçš„ç½‘ç«™åŸŸåï¼Œä¾‹å¦‚ï¼š`baidu.com`å’Œ`ditu.baidu.com`ã€‚å‡è®¾ç™¾åº¦ä½¿ç”¨äº†GAï½ é‚£ä¹ˆGAä¼šåˆ†åˆ«åœ¨ä¸¤ä¸ªåŸŸåä¸‹è®¾ç½®ä¸åŒçš„`_ga` cookieå€¼ï¼Œè¿™æ ·åœ¨`baidu.com`ä¸‹GAä¾¿ä¼šæ‹¿åˆ°ä¸¤ä¸ª`_ga`å€¼ã€‚ä¸çŸ¥é“è¯¥ç”¨å“ªä¸ªï¼Œå‚»å‚»åˆ†ä¸æ¸…æ¥šã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒGAåœ¨cookieçš„å€¼ä¸Šé¢åšæ–‡ç« ã€‚å¯ä»¥çœ‹åˆ°å†²çªåªä¼šå‘ç”Ÿåœ¨çˆ¶å­åŸŸåå’Œçˆ¶å­è·¯å¾„ä¸Šã€‚å› ä¸ºcookieæœ¬èº«çš„ç‰¹æ®Šæ€§ï¼šæ‰€æœ‰httpè¯·æ±‚ä¼šå¸¦ç€è¯¥åŸŸåä¸‹çš„æ‰€æœ‰cookieã€‚å¦‚æœcookieå€¼å¤ªé•¿å¤ªå¤šä¼šæ¶ˆè€—å¤ªå¤šå¸¦å®½ã€‚GAé€šè¿‡è®¡ç®—åŸŸåå’Œè·¯å¾„çš„â€œé•¿åº¦â€æ¥å”¯ä¸€æ ‡ç¤ºè¿™ä¸ªcookieæ‰€è®¾ç½®åœ¨çš„åŸŸåå’Œè·¯å¾„ã€‚è®¡ç®—â€œé•¿åº¦â€çš„æ–¹æ³•å¦‚ä¸‹ï¼š

```javascript
/**
 * normalize domain.
 * remove the first '.' if exist.
 * @param {string} domain domain String
 * @return {string} normalized domain
 */
var normalizeDomain = function (domain) {
    return domain.indexOf('.') === 0 ? domain.substr(1) : domain;
};

/**
 * get count of domain.
 * getDomainCount('qq.com') === 2
 * getDomainCount('.qq.com') === 2
 * getDomainCount('b.qq.com') === 3
 * getDomainCount('e.qidian.qq.com') === 4
 *
 * @param {string} domain domain String
 * @return {string} normalized domain
 */
var getDomainCount = function (domain) {
    return normalizeDomain(domain).split('.').length;
};

/**
 * normalize path
 * normalizePath('') === '/'
 * normalizePath('/') === '/'
 * normalizePath('/ping') === '/ping'
 * normalizePath('/ping/pv') === '/ping/pv'
 * normalizePath('ping/pv') === '/ping/pv'
 * normalizePath('ping/pv/') === '/ping/pv'
 *
 * @param {string} path path
 * @return {string} path
 */
var normalizePath = function (path) {
    if (!path) {
        return '/';
    }

    if (path.length > 1 && path.lastIndexOf('/') === path.length - 1) {
        // remove last '/'
        path = path.substr(0, path.length - 1);
    }

    if (path.indexOf('/') !== 0) {
        // fill up first '/'
        path = '/' + path;
    }

    return path;
};

/**
 * get count of path
 * getPathCount('') === 1
 * getPathCount('/') === 1
 * getPathCount('/ping') === 2
 * getPathCount('/ping/pv') === 3
 * getPathCount('ping/pv') === 3
 * getPathCount('ping/pv/') === 3
 *
 * @param {string} path path
 * @return {number} count of path
 */
var getPathCount = function (path) {
    path = normalizePath(path);
    return path === '/' ? 1 : path.split('/').length;
};

/**
 * Get domain and path count string.
 *      domainCount + '-' + pathCount + '$'
 *
 * @param {Window=} win window context.
 * @param {string=} domain cookie domain.
 * @param {string=} path cookie path.
 * @return {string} count string.
 */
var getDomainAndPathCount = function (win, domain, path) {
    win = win || window;

    var location = win.location;
    var pathCount = getPathCount(path != null ? path : location.pathname);
    var domainCount = getDomainCount(domain != null ? domain : location.hostname);
    return domainCount + (pathCount > 1 ? '-' + pathCount : '') + '-';
};
```

GAåœ¨è®¾ç½®cookieæ—¶åŠ ä¸Š`domain`å’Œ`path`çš„é•¿åº¦å‰ç¼€ï¼Œç„¶ååœ¨å–å‡ºcookieæ—¶éå†æ‰€æœ‰çš„åå­—ç›¸åŒçš„cookieæ‰¾åˆ°æŒ‡å®šåŸŸåå’Œè·¯å¾„ä¸‹çš„cookieã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```javascript
/**
 * Set cookie.
 * @param {string} key cookie name.
 * @param {string|number} value cookie value.
 * @param {Window=} win window context.
 * @param {number=} expires cookie expired time in milliseconds.
 * @param {string=} domain cookie domain.
 * @param {string=} path cookie path.
 * @return {boolean} success or not.
 */
var setCookie = function (key, value, win, expires, domain, path) {
    var domainAndPathCount = getDomainAndPathCount(win, domain, path);
    value = value + '';
    return setCookieRaw(key, domainAndPathCount + value.replace(/\-/g, '%2d'), win, expires, domain, path);
};
/**
 * Get cookie value.
 *
 * @param {string} key key name.
 * @param {Window=} win window context.
 * @param {string=} domain cookie domain.
 * @param {string=} path cookie path.
 * @return {string} cookie value.
 */
var getCookie = function (key, win, domain, path) {
    var results = getCookieRaw(key, win);
    var domainAndPathCount = getDomainAndPathCount(win, domain, path);
    for (var i = 0; i < results.length; i++) {
        var r = results[i];
        if (r.indexOf(domainAndPathCount) === 0) {
            return r.slice(domainAndPathCount.length).replace(/%2d/g, '-');
        }
    }
    return '';
};
```

é­”é¬¼ğŸ‘¹è—äºç»†èŠ‚ã€‚GAå¯¹ç»†èŠ‚çš„è¿½æ±‚å¹¶æ²¡æœ‰æ­¢æ­¥äºæ­¤ã€‚cookieå`_ga`è™½ç„¶ä¸€èˆ¬å¾ˆå°‘æœ‰å¼€å‘è€…ä¼šç”¨åˆ°ï¼Œä½†æ˜¯ä¸æ€•ä¸€ä¸‡å°±æ€•ä¸‡ä¸€ã€‚å¦‚æœcookieå`_ga`å†²çªäº†å¹¶è¢«æ”¹å†™æˆäº†åˆ«çš„å€¼ï¼Œé‚£ä¹ˆGAå¾ˆå¯èƒ½ä¼šå‘é€ä¸€ä¸ªä¸ç¬¦åˆè¦æ±‚çš„å€¼è¿‡å»ã€‚è¿™å¯¹æœåŠ¡å™¨ç«¯è§£æä¹Ÿéå¸¸ä¸åˆ©ã€‚

GAåœ¨cookieçš„å€¼ä¹‹å‰åˆåŠ äº†å‰ç¼€`GA1.`ï¼Œä¸‹æ¬¡ä½¿ç”¨è¿™ä¸ªcookieæ—¶éƒ½ä¼šæ£€æŸ¥æ˜¯å¦å¸¦æœ‰`GA1.`å‰ç¼€ã€‚å¦‚æœä¸å­˜åœ¨å‰ç¼€åˆ™ç›´æ¥è¦†ç›–ç”Ÿæˆæ–°çš„ï¼Œå¦‚æœå­˜åœ¨åˆ™ç»§ç»­å¤ç”¨åŸcookieå€¼ã€‚

é™¤äº†é˜²æ­¢`_ga`è¢«å¼€å‘è€…è¦†ç›–ä¹‹å¤–ï¼ŒçŒœæƒ³è¿˜æœ‰ä¸€ä¸ªä½œç”¨ï¼Œå°±æ˜¯â€œç‰ˆæœ¬å·â€ã€‚å¤šä¸ªGAç‰ˆæœ¬ä¹‹é—´å¦‚æœ`_ga`çš„cookieå€¼ç”Ÿæˆç®—æ³•ä¸ä¸€æ ·éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œé‚£ä¹ˆå¯ä»¥ä¾æ®`GA1.`å‰ç¼€æ¥åˆ¤æ–­åº”è¯¥æ˜¯å“ªä¸ªç‰ˆæœ¬ï¼Œé‡‡å–æ­£ç¡®çš„æ“ä½œã€‚

æ€»ç»“ä¸‹`_ga` cookieå€¼çš„æ ¼å¼å¦‚ä¸‹ï¼š

```javascript
// GA{version}.{domainCount}[-{pathCount}].{randomNumber}.{time}
// pathæ˜¯'/'æ—¶
document.cookie = '_ga=GA1.3.494346849.1446193077';
// æ²¡æœ‰pathæ—¶
document.cookie = '_ga=GA1.3-2.494346849.1446193077';
```

> ç»†å¾®ä¹‹å¤„è§çœŸç« :+1:

å‚è€ƒæ–‡æ¡£ï¼š

1. [RFC 2109](https://tools.ietf.org/html/rfc2109)
2. [RFC 2965](http://www.ietf.org/rfc/rfc2965.txt)
3. [RFC 6265](https://tools.ietf.org/html/rfc6265)
4. [What does the dot prefix in the cookie domain mean?](http://stackoverflow.com/questions/9618217/what-does-the-dot-prefix-in-the-cookie-domain-mean)
5. [MDN document.cookie](https://developer.mozilla.org/en-US/docs/Web/API/document/cookie?redirectlocale=en-US&redirectslug=DOM%2Fdocument.cookie)
